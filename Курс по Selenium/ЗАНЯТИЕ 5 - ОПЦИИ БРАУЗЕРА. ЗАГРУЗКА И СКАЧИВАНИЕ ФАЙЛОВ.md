ЗАНЯТИЕ 5 - ОПЦИИ БРАУЗЕРА. ЗАГРУЗКА И СКАЧИВАНИЕ ФАЙЛОВ
Запись занятия
Первое знакомство с опциями браузера
Работа с обьектом опций
Основные базовые опции браузера
Стратегия загрузки страницы
Загрузка файлов
Скачивание файлов

Первое знакомство с опциями браузера
Опции браузера - это по сути его настройки перед запуском (возможности браузера), в будущем, мы разберем много разных опций, но начнем с самых распространенных.


Работа с обьектом опций
В первую очередь, необходимо создать обьект для опций, до инициализации драйвера.
options = webdriver.ChromeOptions()
Теперь мы можем обявить нашу первую опцию, используя специальный метод:
options.add_argument("")
Внутри ковычек, необходимо прописать нужную нам опцию, давайте изучим первую и научимся запускать браузер в режиме невидимки.

Для этого используем опцию —headless, можно перевести, как без головы)
# Опции браузера
options = webdriver.ChromeOptions()
options.add_argument("--headless")

# Инициализация драйвера
service = Service(ChromeDriverManager().install())
driver = webdriver.Chrome(service=service, options=options)

driver.get("https://ya.ru")
Обязательно прокиньте созданный обьект options в аргументы Chrome в виде options=options
driver = webdriver.Chrome(service=service, options=options)
Теперь если попробуете запустить такой код, то увидите, что браузер как будто не работает, но на деле он откроется в фоне. Вопрос, для чего это нужно? Для ускорения автоматизации и в будущем для CI/CD)




Основные базовые опции браузера
➖ Безголовый режим "--headless" -
Запускает браузер в режиме без графического интерфейса. Это позволяет выполнять тесты в фоновом режиме без отображения окна браузера.

➖ Режим инкогнито "--incognito" -
Запускает браузер в режиме инкогнито (приватного просмотра). Это позволяет тестировать поведение сайта без использования кэша и сохраненных данных.

➖ Игнорирование ошибок сертификатов "--ignore-certificate-errors" -
Игнорирует ошибки сертификата SSL при загрузке защищенных (HTTPS) страниц.

➖ Размер окна браузера "--window-size=X,Y" -
устанавливает размер окна браузера. Можно указать ширину и высоту в пикселях. Например, --window-size=1280,800.

➖ Отключение кеширования "--disable-cache" -
отключает кэширование в браузере. Это позволяет загружать каждый ресурс (например, изображения, стили, скрипты) с сервера при каждой загрузке страницы.



Стратегия загрузки страницы
Существует такая вещь, как стратегия загрузки страницы, она нужна для того, чтобы Selenium понимал стоит ли ему ждать загрузки всех компонентов страницы, какую-то часть или вообще ничего не ждать.

Cуществует три вида стратегии загрузки:

➖ normal - используется по дефолту и ожидает загрузки все ресурсов (картинки, js-код, шрифты и т.д) на странице.

➖ eager - ожидает только готовности загрузки DOM (html-структуры), но при этом картинки и прочее может до сих пор грузиться.

➖ none - Вообще ничего не ждет, не знаю зачем это придумали ахха

Применить определенную стратегию, можно используя ранее изученную тему про опции.


Реализация normal strategy:
options = Options()
options.page_load_strategy = 'normal'

service = Service(ChromeDriverManager().install())
driver = webdriver.Chrome(service=service, options=options)
driver.get("https://whatismyipaddress.com/")
При запуске этого когда, мы увидем, что браузер не закроется, пока все ресурсы страницы не будут загружены.


Рерализация eager strategy:
options = Options()
options.page_load_strategy = 'eager'

service = Service(ChromeDriverManager().install())
driver = webdriver.Chrome(service=service, options=options)
driver.get("https://whatismyipaddress.com/")
При запуске такого кода, мы уже визуально заметим, что браузер закрывается еще не дождавшись подгрузки картинок например.


Реализация none strategy:
options = Options()
options.page_load_strategy = 'none'

service = Service(ChromeDriverManager().install())
driver = webdriver.Chrome(service=service, options=options)
driver.get("https://whatismyipaddress.com/")
В таком случае, вы ничего не увидите.



Загрузка файлов
Начнем с загрузки файлов, тут все удивительно и максимально просто, но и нюансы тоже есть.

Для загрузки файлов на сайт используется уже сильно знакомый нам метод send_keys(), и принимает в качестве аргумента путь до нужного файла.

На самом деле, загрузка файлов на сайтах реализована тегом <input>, но выделяется он специальным атрибутом <input type=”file”/> .

Давайте попробуем загрузить файл на сайт, для примера возьмем форму с сайта для практики: https://demoqa.com/upload-download

Тут мы можем увидеться такую кнопку “choose file”:

Проверим кнопку через DevTools и увидим следующее:

А именно, мы видим, что у тега input как раз таки есть атрибут type=”file” - это то что нужно!

Переходим к коду:
driver.get("https://demoqa.com/upload-download")

# Записываем поле ввода в переменную
upload_file_field = driver.find_element(By.XPATH, "//input[@id='uploadFile']")

# Загружаем картинку
upload_file_field.send_keys("АБСОЛЮТНЫЙ ПУТЬ+/files/picture.jpg")

time.sleep(5)
В результате мы увидем успешно загруженный файл:

Так же, я рекомендую использовать os.getcwd() для того, чтобы путь к файлу не зависел от вашей ОС, что в дальнейшем позволит запускать тесты где угодно.

os.getcwd() - возвращает путь до текущей директрии и вернет что-то вроде /Users/manikosto/Documents/SeleniumClasses/lesson_6/

Пример:
import os

element.send_keys(f"{os.getcwd()}/files/picture.jpg")
Важно: В случае если у вас Windows при ошибке скачивания или загрузки файлов, необходимо использовать обратный слеш в путях к файлам.

Пример: \files\picture.jpg
Нюансы при загрузке файлов
Зачастую загрузку файлов могу реализовывать через кнопку, но это кнопка и попытаясь проверить ее через DevTools, станет непонятно, как же тогда загрузить файл, тут и открывается один нюанс.

На самом деле, элементы для непосредственно загрузки файлов скрыты! Но мы можем найти их по поиску в DevTools, так как мы знаем что нам нужен input с атрибутом type=”file”

Используем для поиска Xpath и уоля:

Теперь со спокойной душой можно загружать в него нужный нам файл, хотя input и невидим.




Скачивание файлов
Давайте откроем сайт http://the-internet.herokuapp.com/download

Мы увидим, что для скачивания файлов, казалось бы, ничего не нужно, достаточно кликнуть по ссылке и все, ведь руками все работает, но…

Помним, что мы работаем с WebDriver, и тут в явном виде нужно указывать все опции, для того куда по умолчанию мы хотим скачивать файлы тоже. Да, у вас сработает простой клик, и файл скачается, но вот только куда…

Создадим папку downloads в нашем проекте, туда и будем складывать скачанные файлы:
|- lesson_6
    |- downloads
Теперь все готово, можно приступать к настройке браузера через код, для этого мы создадим словарь preferences и положим в него нужные настройки.
preferences = {
    "download.default_directory" : os.getcwd() + "/downloads", # для Windows в пути прописывать обратный слеш "\downloads"
}
Таким образом, мы указываем браузеру, куда по дефолту нужно сохранять файлы.

Теперь нужно все это как-то передать внутрь браузера, и сделаем мы это через наши уже любимые Options()
options = Options()
preferences = {
    "download.default_directory" : os.getcwd() + "/downloads",
}
options.add_experimental_option("prefs", preferences)
Замечу, что тут мы не использовали options.add_argument() , потому что добавление настроек является экспериментальной фичей, поэтому мы явно указываем add_experimental_option, а “prefs” - это ключевое слово в качестве первого аргумента, оно не меняется, вторым же аргументом идет наш словарь настроек.

Это нужно просто помнить, но запоминать особо необязательно, так как в реальном проекте вы напишете это один раз и больше, вероятно, никогда на эти строчки и не взгляните)

Посмотрим на конечный код:
# Инициализируем опции
options = Options()
preferences = {
    "download.default_directory" : os.getcwd() + "/downloads",
}
options.add_experimental_option("prefs", preferences)

service = Service(ChromeDriverManager().install())
# Добавляем опции в браузер
driver = webdriver.Chrome(service=service, options=options)

# Открываем страницу для скачивания файлов
driver.get("http://the-internet.herokuapp.com/download")

# Найдем все элементы и кликнем на любой
ELEMENTS = driver.find_elements(By.XPATH, "//a")
ELEMENTS[7].click()
Нюансы при скачивании файлов
Все бы хорошо, но на windows может встретиться проблема, например, подтверждение на скачивание файлов и тому подобные окошки.

Чтобы обходить такие вещи, добавим к нашим настройкам строчку:
preferences = {
    "download.default_directory" : os.getcwd() + "/downloads",
    "safebrowsing.enabled" : False
}



ПРАКТИЧЕСКОЕ ЗАДАНИЕ
Домашнее задание
Домашнее задание на тему "Опции браузера, загрузка и скачивание файлов"

Задание 1
Загрузить любой файл в 'Choose File'.
Страница для выполнения задания: https://demoqa.com/upload-download

Задание 2
С помощью цикла for скачать все файлы в папку lesson_6/downloads
Страница для выполнения задания: http://the-internet.herokuapp.com/download



